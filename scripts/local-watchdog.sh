#!/usr/bin/env bash
# üß† LazyLogic Local Linux Self-Healing Watchdog with DNS Fallback

NTFY_TOPIC="lazylogic-global"
SITES=("https://lazylogic.netlify.app" "https://lazylogic.org")
LOGFILE="$HOME/lazylogic/scripts/watchdog.log"
TIMESTAMP="$(date '+%F %T')"

log() { echo "[$TIMESTAMP] $1" | tee -a "$LOGFILE"; }

notify() {
  local msg="$1"; local title="$2"; local tags="$3"
  curl -fsS -d "$msg" -H "Title: $title" -H "Tags: $tags" \
    https://ntfy.sh/$NTFY_TOPIC >/dev/null 2>&1
}

for site in "${SITES[@]}"; do
  host="$(echo "$site" | sed 's~https://~~;s~/~~')"
  log "üîé Checking $site ..."
  resp="$(curl -fsSL --max-time 20 "$site" || true)"
  if [ -z "$resp" ]; then
    log "‚ùå Empty response for $site. Flushing DNS and retrying..."
    sudo systemd-resolve --flush-caches || true
    dig +short "$host" || true
    sleep 5
    resp="$(curl -fsSL --max-time 20 "$site" || true)"
  fi
  if [ -z "$resp" ]; then
    log "üö® $site still unreachable after DNS retry."
    notify "‚ùå $site unreachable even after DNS retry." "LazyLogic Watchdog" "warning,skull"
    continue
  fi
  if echo "$resp" | grep -q "index.html 200"; then
    log "‚ö†Ô∏è Found stray 'index.html 200' text at $site."
    notify "‚ö†Ô∏è $site shows stray 'index.html 200' text ‚Äî possible misrender." \
      "LazyLogic Watchdog" "alert,code"
    continue
  fi
  if ! ping -c1 -W3 "$host" >/dev/null 2>&1; then
    log "‚ö†Ô∏è Ping failed for $host ‚Äî possible network issue."
    notify "‚ö†Ô∏è Ping to $host failed after DNS check." "LazyLogic Network Check" "wifi,warning"
    continue
  fi
  log "‚úÖ $site verified clean and reachable."
  notify "‚úÖ $site verified clean and reachable (Linux local check)." \
    "LazyLogic Watchdog" "rocket,white_check_mark"
done
