name: ü©∫ LazyLogic Self-Healing Watcher (Termux Optimized)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  heal:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: üîç Check LazyLogic Domains
        id: check
        shell: bash
        run: |
          FAIL=0
          for site in https://lazylogic.netlify.app https://lazylogic.org; do
            echo "üîé Checking $site ..."
            resp="$(curl -fsSL --max-time 20 "$site" || true)"
            if [ -z "$resp" ]; then echo "‚ùå Empty response"; FAIL=1; fi
            echo "$resp" | grep -q "index.html 200" && { echo "‚ö†Ô∏è Found stray HTML 200 text"; FAIL=1; }
          done
          echo "fail=$FAIL" >> $GITHUB_OUTPUT

      - name: ‚úÖ Notify Success via NTFY
        if: steps.check.outputs.fail == '0'
        run: |
          curl -fsS -d "‚úÖ LazyLogic verified clean on both domains." \
            -H "Title: LazyLogic Verified" \
            -H "Tags: rocket,coffee,white_check_mark" \
            https://ntfy.sh/lazylogic-global || true

      - name: üö® Auto-Rollback & Alert via NTFY
        if: steps.check.outputs.fail == '1'
        run: |
          git config user.name "lazylogic-autoheal"
          git config user.email "autoheal@users.noreply.github.com"
          git fetch origin master
          git checkout -B master origin/master
          git reset --hard HEAD~1
          git push origin HEAD:master --force
          curl -fsS -d "‚ö†Ô∏è Detected site issue ‚Äî rolled back to previous commit and redeployed." \
            -H "Title: LazyLogic Auto-Heal Triggered" \
            -H "Priority: high" \
            -H "Tags: warning,skull" \
            https://ntfy.sh/lazylogic-global || true
